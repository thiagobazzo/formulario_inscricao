<script>
function onlyDigits(v){ return (v||"").replace(/\D/g,''); }

function maskTelefone(v){
  const d = onlyDigits(v).slice(0,11);

  if (d.length <= 2) return d;
  if (d.length <= 6) return `(${d.slice(0,2)}) ${d.slice(2)}`;

  if (d.length <= 10)
    return `(${d.slice(0,2)}) ${d.slice(2,6)}-${d.slice(6)}`;

  return `(${d.slice(0,2)}) ${d.slice(2,7)}-${d.slice(7)}`;
}

function maskRG(v){
  const d = onlyDigits(v).slice(0,9);
  if (d.length <= 2) return d;
  if (d.length <= 5) return `${d.slice(0,2)}.${d.slice(2)}`;
  if (d.length <= 8) return `${d.slice(0,2)}.${d.slice(2,5)}.${d.slice(5)}`;
  return `${d.slice(0,2)}.${d.slice(2,5)}.${d.slice(5,8)}-${d.slice(8)}`;
}

document.addEventListener("DOMContentLoaded", () => {
  const tel = document.getElementById("telefone");
  const rg = document.getElementById("rg");
  const rgResp = document.getElementById("rg_responsavel");
  const idade = document.getElementById("idade");
  const box = document.getElementById("box_responsavel");

  tel.addEventListener("input", e => e.target.value = maskTelefone(e.target.value));
  rg.addEventListener("input", e => e.target.value = maskRG(e.target.value));
  if (rgResp) rgResp.addEventListener("input", e => e.target.value = maskRG(e.target.value));

  idade.addEventListener("input", () => {
    if (parseInt(idade.value||"0",10) < 18) box.classList.remove("hidden");
    else box.classList.add("hidden");
  });

  document.getElementById("form").addEventListener("submit", async (e)=>{
    e.preventDefault();

    const payload = {
      nome_completo: nome_completo.value,
      idade: idade.value,
      telefone: telefone.value,
      rg: rg.value,
      nome_responsavel: nome_responsavel?.value,
      rg_responsavel: rg_responsavel?.value
    };

    const r = await fetch("/api/inscrever", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    const data = await r.json();
    if (!r.ok){ alert(data.erro); return; }

    window.location.href = data.comprovante_url;
  });
});
</script>
